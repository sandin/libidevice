#include "idevice/dtxmessagetransmitter.h"

#include <map>
#include <cstdlib> // abs
#include <vector>
#include <gtest/gtest.h>
#include <memory> // std::shared_ptr

#include "idevice/idevice.h"
#include "idevice/bytebuffer.h"
#include "idevice/dtxmessage.h"

#ifdef ENABLE_NSKEYEDARCHIVE_TEST
#include "nskeyedarchiver/nskeyedarchiver.hpp"
#include "nskeyedarchiver/nskeyedunarchiver.hpp"
#include "nskeyedarchiver/kamap.hpp"
#endif

using namespace idevice;

#ifdef ENABLE_NSKEYEDARCHIVE_TEST
TEST(DTXMessageTransmitterTest, TransmitMessage) {
  std::shared_ptr<DTXMessage> message = DTXMessage::Create("_requestChannelWithCode:identifier:");
  uint32_t msg_identifier = 1;
  message->SetIdentifier(msg_identifier);
  
  // aux_0: type=3, key=code, value=1
  uint32_t channel_code = 2;
  message->AppendAuxiliary(DTXPrimitiveValue(static_cast<int32_t>(channel_code)));
  
  // aux_1: type=2, key=identifier, value=bplist(str)
  const char* channel_identifier = "com.apple.instruments.server.services.deviceinfo";
  message->AppendAuxiliary(nskeyedarchiver::KAValue(channel_identifier));
  
  ByteBuffer send_buffer(8192);
  DTXMessageTransmitter transmitter;
  transmitter.TransmitMessage(message, 0, {msg_identifier, 0, 0}, [&](const char* data, size_t size) -> bool {
    send_buffer.Append(data, size);
    return true;
  });
  idevice::hexdump(send_buffer.GetBuffer(0), send_buffer.Size(), 0);
  printf("=================================\n");

  const unsigned char expect_data[451] = {
  //     0     1     2     3     4     5     6     7     8     9     a     b     c     d     e     f
  //  <DTXMessageHeader>
      0x79, 0x5B, 0x3D, 0x1F, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0xA3, 0x01, 0x00, 0x00,
  //  | magic=0x1F3D5B79      | msg_header_size=32    | fg_idx=0  | fg_cnt=1 | length=419          |
      0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
  //  | identifier=1          | conv_idx=0            | channel_code=0        | expects_reply=1    |
  //  <DTXMessagePayloadHeader>
      0x02, 0x00, 0x00, 0x00, 0xE4, 0x00, 0x00, 0x00, 0x93, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //  | msg_type=2            | aux_len=228           | total_len=403                              |
  //  <DTXPrimitiveArray>
      0xF0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xD4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //  | capacity=496                                        | size=212                             |
      0x0A, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00,
  //  | type=10               | type=3                | aux_0:channel_code=2  | type=10            |
      0x02, 0x00, 0x00, 0x00, 0xBC, 0x00, 0x00, 0x00, 0x62, 0x70, 0x6C, 0x69, 0x73, 0x74, 0x30, 0x30,
  //  | type=2                | value_len=188         | aux_1:offset=0x58, value=bplist...
      0xD4, 0x01, 0x03, 0x05, 0x09, 0x02, 0x04, 0x06, 0x0A, 0x58, 0x24, 0x76, 0x65, 0x72, 0x73, 0x69,
  //  bplist:"com.apple.instruments.server.services.deviceinfo"
      0x6F, 0x6E, 0x12, 0x00, 0x01, 0x86, 0xA0, 0x59, 0x24, 0x61, 0x72, 0x63, 0x68, 0x69, 0x76, 0x65,
      0x72, 0x5F, 0x10, 0x0F, 0x4E, 0x53, 0x4B, 0x65, 0x79, 0x65, 0x64, 0x41, 0x72, 0x63, 0x68, 0x69,
      0x76, 0x65, 0x72, 0x54, 0x24, 0x74, 0x6F, 0x70, 0xD1, 0x07, 0x08, 0x54, 0x72, 0x6F, 0x6F, 0x74,
      0x80, 0x01, 0x58, 0x24, 0x6F, 0x62, 0x6A, 0x65, 0x63, 0x74, 0x73, 0xA2, 0x0B, 0x0C, 0x55, 0x24,
      0x6E, 0x75, 0x6C, 0x6C, 0x5F, 0x10, 0x30, 0x63, 0x6F, 0x6D, 0x2E, 0x61, 0x70, 0x70, 0x6C, 0x65,
      0x2E, 0x69, 0x6E, 0x73, 0x74, 0x72, 0x75, 0x6D, 0x65, 0x6E, 0x74, 0x73, 0x2E, 0x73, 0x65, 0x72,
      0x76, 0x65, 0x72, 0x2E, 0x73, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x73, 0x2E, 0x64, 0x65, 0x76,
      0x69, 0x63, 0x65, 0x69, 0x6E, 0x66, 0x6F, 0x08, 0x11, 0x1A, 0x1F, 0x29, 0x3B, 0x40, 0x43, 0x48,
      0x4A, 0x53, 0x56, 0x5C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x8F, 0x62, 0x70, 0x6C, 0x69, 0x73, 0x74, 0x30, 0x30, 0xD4, 0x01, 0x03, 0x05,
  //                          <DTXMessagePayload>
  //                          | payload, offset=0x114, size=175, value=bplist...
      0x09, 0x02, 0x04, 0x06, 0x0A, 0x58, 0x24, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x12, 0x00,
  //  bplist:"_requestChannelWithCode:identifier:"
      0x01, 0x86, 0xA0, 0x59, 0x24, 0x61, 0x72, 0x63, 0x68, 0x69, 0x76, 0x65, 0x72, 0x5F, 0x10, 0x0F,
      0x4E, 0x53, 0x4B, 0x65, 0x79, 0x65, 0x64, 0x41, 0x72, 0x63, 0x68, 0x69, 0x76, 0x65, 0x72, 0x54,
      0x24, 0x74, 0x6F, 0x70, 0xD1, 0x07, 0x08, 0x54, 0x72, 0x6F, 0x6F, 0x74, 0x80, 0x01, 0x58, 0x24,
      0x6F, 0x62, 0x6A, 0x65, 0x63, 0x74, 0x73, 0xA2, 0x0B, 0x0C, 0x55, 0x24, 0x6E, 0x75, 0x6C, 0x6C,
      0x5F, 0x10, 0x23, 0x5F, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x43, 0x68, 0x61, 0x6E, 0x6E,
      0x65, 0x6C, 0x57, 0x69, 0x74, 0x68, 0x43, 0x6F, 0x64, 0x65, 0x3A, 0x69, 0x64, 0x65, 0x6E, 0x74,
      0x69, 0x66, 0x69, 0x65, 0x72, 0x3A, 0x08, 0x11, 0x1A, 0x1F, 0x29, 0x3B, 0x40, 0x43, 0x48, 0x4A,
      0x53, 0x56, 0x5C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x82
  };
  idevice::hexdump((void*)&expect_data, sizeof(expect_data), 0);
  
  ASSERT_EQ(send_buffer.Size(), sizeof(expect_data));
  char* acutal_ptr = reinterpret_cast<char*>(send_buffer.GetBuffer(0));
  for (int i = 0; i < send_buffer.Size(); ++i) {
    ASSERT_EQ((char)*(acutal_ptr + i), (char)expect_data[i]);
  }
}
#endif // ENABLE_NSKEYEDARCHIVE_TEST
